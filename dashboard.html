<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShowBox - Billing Dashboard</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="IPTV Billing & Reseller Management System">
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Billing Panel">
    <link rel="manifest" href="manifest.json">

    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="72x72" href="icons/icon-72x72.png">
    <link rel="apple-touch-icon" sizes="96x96" href="icons/icon-96x96.png">
    <link rel="apple-touch-icon" sizes="128x128" href="icons/icon-128x128.png">
    <link rel="apple-touch-icon" sizes="144x144" href="icons/icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="384x384" href="icons/icon-384x384.png">
    <link rel="apple-touch-icon" sizes="512x512" href="icons/icon-512x512.png">

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="shortcut icon" href="favicon.png">

    <link rel="stylesheet" href="dashboard.css">

    <!-- Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p class="loading-text">Loading dashboard...</p>
    </div>

    <nav class="navbar">
        <h1>ShowBox Billing Panel</h1>
        <div class="user-info">
            <span id="user-balance"></span>
            <span id="username-display"></span>
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark Mode">
                <span id="theme-icon">‚òÄÔ∏è</span>
            </button>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </nav>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Accounts</h3>
                <div class="value" id="total-accounts">0</div>
            </div>
            <div class="stat-card">
                <h3>Your Balance</h3>
                <div class="value" id="balance-display">¬£0</div>
            </div>
            <div class="stat-card">
                <h3>Total Resellers</h3>
                <div class="value" id="total-resellers">0</div>
            </div>
            <div class="stat-card">
                <h3>Total Plans</h3>
                <div class="value" id="total-plans">0</div>
            </div>
            <div class="stat-card expiring-soon">
                <h3>Expiring Soon</h3>
                <div class="value" id="expiring-soon">0</div>
                <small style="color: #666; font-size: 12px;">Next 2 weeks</small>
            </div>
            <div class="stat-card expired-last-month">
                <h3>Expired Last Month</h3>
                <div class="value" id="expired-last-month">0</div>
                <small style="color: #fff; font-size: 12px;">Not renewed</small>
            </div>
        </div>

        <!-- View Mode Toggle (for reseller admins) -->
        <div id="view-mode-toggle" style="display: none; justify-content: center; align-items: center; gap: 12px; margin: 20px 0; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius-md); border: 1px solid var(--border-color);">
            <label class="toggle-switch">
                <input type="checkbox" id="view-all-accounts" onchange="toggleAccountViewMode()">
                <span class="toggle-slider"></span>
            </label>
            <span id="view-mode-label" style="font-size: 14px; font-weight: 500; color: var(--text-secondary);">View All Accounts</span>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('accounts')">Accounts</button>
            <button class="tab" onclick="switchTab('resellers')">Resellers</button>
            <button class="tab" onclick="switchTab('plans')">Plans</button>
            <button class="tab" onclick="switchTab('transactions')">Transactions</button>
            <button class="tab" onclick="switchTab('stb-control')">STB Control</button>
            <button class="tab" onclick="switchTab('reports')">Reports</button>
            <button class="tab" onclick="switchTab('settings')">Settings</button>
        </div>

        <div class="content">
            <div id="alert" class="alert"></div>

            <!-- Accounts Tab -->
            <div id="accounts-tab" class="tab-content active">
                <div class="section-header">
                    <h2>Account Management</h2>
                    <button class="btn-primary" onclick="openModal('addAccountModal')">+ Add Account</button>
                </div>
                <div class="search-container">
                    <input type="text" id="accounts-search" placeholder="Search by username, name, MAC, or tariff..." onkeyup="searchAccounts()">
                </div>
                <div class="pagination-controls">
                    <div class="per-page-selector">
                        <label>Show:</label>
                        <select id="accounts-per-page" onchange="changeAccountsPerPage()">
                            <option value="25">25 per page</option>
                            <option value="100">100 per page</option>
                        </select>
                    </div>
                    <div id="accounts-pagination-info" class="pagination-info"></div>
                </div>
                <table id="accounts-table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Full Name</th>
                            <th>Phone</th>
                            <th>MAC Address</th>
                            <th>Tariff Plan</th>
                            <th>Reseller</th>
                            <th>Status</th>
                            <th>Expiration Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="accounts-tbody">
                        <tr><td colspan="9" style="text-align:center;padding:40px;color:#999">Loading...</td></tr>
                    </tbody>
                </table>
                <div id="accounts-pagination" class="pagination-buttons"></div>
            </div>

            <!-- Resellers Tab -->
            <div id="resellers-tab" class="tab-content">
                <div class="section-header">
                    <h2>Reseller Management</h2>
                    <button class="btn-primary" onclick="openModal('addResellerModal')">+ Add Reseller</button>
                </div>
                <table id="resellers-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Balance</th>
                            <th>Max Users</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="resellers-tbody">
                        <tr><td colspan="6" style="text-align:center;padding:40px;color:#999">Loading...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Plans Tab -->
            <div id="plans-tab" class="tab-content">
                <div class="section-header">
                    <h2>Plan Management</h2>
                    <button class="btn-primary" onclick="openModal('addPlanModal')">+ Add Plan</button>
                </div>
                <table id="plans-table">
                    <thead>
                        <tr>
                            <th>Plan ID</th>
                            <th>Name</th>
                            <th>Currency</th>
                            <th>Price</th>
                            <th>Days</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="plans-tbody">
                        <tr><td colspan="6" style="text-align:center;padding:40px;color:#999">Loading...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Transactions Tab -->
            <div id="transactions-tab" class="tab-content">
                <div class="section-header">
                    <h2>Transaction History</h2>
                </div>
                <table id="transactions-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Currency</th>
                            <th>Type</th>
                            <th id="reseller-column-header">Reseller</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-tbody">
                        <tr><td colspan="6" style="text-align:center;padding:40px;color:#999">Loading...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- STB Control Tab -->
            <div id="stb-control-tab" class="tab-content">
                <div class="section-header">
                    <h2>STB Device Control</h2>
                    <p style="color: #666; font-size: 14px; margin-top: 8px;">Send commands and messages to Set-Top Box devices</p>
                </div>

                <div class="stb-control-container">
                    <!-- Send Event Section -->
                    <div class="stb-control-section">
                        <h3>Send Event to Device</h3>
                        <form id="stbEventForm" onsubmit="sendStbEvent(event)">
                            <div class="form-group">
                                <label>MAC Address *</label>
                                <input type="text" id="event-mac" name="mac" required placeholder="00:1A:79:XX:XX:XX">
                            </div>

                            <div class="form-group">
                                <label>Event Type *</label>
                                <select id="event-type" name="event" required>
                                    <option value="">-- Select Event --</option>
                                    <option value="reboot">Reboot</option>
                                    <option value="reload_portal">Reload Portal</option>
                                    <option value="update_channels">Update Channels</option>
                                    <option value="play_channel">Play Channel</option>
                                    <option value="play_radio_channel">Play Radio Channel</option>
                                    <option value="update_image">Update Image</option>
                                    <option value="show_menu">Show Menu</option>
                                    <option value="cut_off">Cut Off</option>
                                </select>
                            </div>

                            <!-- Additional fields for specific events -->
                            <div id="channel-field" class="form-group" style="display: none;">
                                <label>Channel ID</label>
                                <input type="text" id="channel-id" name="channel_id" placeholder="Enter channel ID">
                            </div>

                            <button type="submit" class="btn-primary">Send Event</button>
                        </form>
                    </div>

                    <!-- Send Message Section -->
                    <div class="stb-control-section">
                        <h3>Send Message to Device</h3>
                        <form id="stbMessageForm" onsubmit="sendStbMessage(event)">
                            <div class="form-group">
                                <label>MAC Address *</label>
                                <input type="text" id="message-mac" name="mac" required placeholder="00:1A:79:XX:XX:XX">
                            </div>

                            <div class="form-group">
                                <label>Message *</label>
                                <textarea id="message-text" name="message" rows="4" required placeholder="Enter message to display on device..."></textarea>
                            </div>

                            <button type="submit" class="btn-primary">Send Message</button>
                        </form>
                    </div>
                </div>

                <!-- Recent STB Actions -->
                <div class="stb-actions-history" style="margin-top: 30px;">
                    <h3>Recent Actions</h3>
                    <div id="stb-history" class="stb-history-list">
                        <p style="color: #999; text-align: center; padding: 20px;">No recent actions</p>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports-tab" class="tab-content">
                <div class="section-header">
                    <h2>Reports & Analytics</h2>
                </div>

                <!-- Dynamic Filters Section -->
                <div id="dynamic-reports-section" class="report-filters">
                    <div class="filter-group">
                        <label>üìÖ Expired & Not Renewed:</label>
                        <select id="expired-filter" onchange="handleExpiredFilterChange()">
                            <option value="7">Last 7 Days</option>
                            <option value="14">Last 14 Days</option>
                            <option value="30" selected>Last 30 Days</option>
                            <option value="60">Last 60 Days</option>
                            <option value="90">Last 90 Days</option>
                            <option value="180">Last 6 Months</option>
                            <option value="365">Last Year</option>
                            <option value="custom">Custom Days</option>
                        </select>
                        <div id="expired-custom-input" style="display: none;" class="custom-input-group">
                            <input type="number" id="expired-custom-days" min="1" max="3650" placeholder="Enter days" onchange="updateDynamicReports()">
                            <small>Enter number of days (1-3650)</small>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label>‚è∞ Expiring Accounts in Next:</label>
                        <select id="expiring-filter" onchange="handleExpiringFilterChange()">
                            <option value="7">Next 7 Days</option>
                            <option value="14" selected>Next 14 Days</option>
                            <option value="30">Next 30 Days</option>
                            <option value="60">Next 60 Days</option>
                            <option value="90">Next 90 Days</option>
                            <option value="custom">Custom Days</option>
                        </select>
                        <div id="expiring-custom-input" style="display: none;" class="custom-input-group">
                            <input type="number" id="expiring-custom-days" min="1" max="3650" placeholder="Enter days" onchange="updateDynamicReports()">
                            <small>Enter number of days (1-3650)</small>
                        </div>
                    </div>
                </div>

                <!-- Dynamic Report Cards -->
                <div id="dynamic-reports-cards" class="dynamic-reports">
                    <div class="report-card dynamic-card clickable-report" onclick="showReportAccountsList('expired-dynamic')" title="Click to view list of expired accounts">
                        <div class="report-icon" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                            <span>üìâ</span>
                        </div>
                        <div class="report-details">
                            <h3>Expired & Not Renewed</h3>
                            <div class="report-value" id="dynamic-expired-count">0</div>
                            <small id="dynamic-expired-label">Last 30 days</small>
                        </div>
                        <div class="report-export-buttons">
                            <button class="btn-export btn-export-pdf" onclick="event.stopPropagation(); exportReport('expired-dynamic', 'pdf')" title="Export as PDF">üìÑ PDF</button>
                            <button class="btn-export btn-export-excel" onclick="event.stopPropagation(); exportReport('expired-dynamic', 'excel')" title="Export as Excel">üìä Excel</button>
                        </div>
                    </div>

                    <div class="report-card dynamic-card clickable-report" onclick="showReportAccountsList('expiring-dynamic')" title="Click to view list of expiring accounts">
                        <div class="report-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                            <span>üìà</span>
                        </div>
                        <div class="report-details">
                            <h3>Expiring in Selected Period</h3>
                            <div class="report-value" id="dynamic-expiring-count">0</div>
                            <small id="dynamic-expiring-label">Next 14 days</small>
                        </div>
                        <div class="report-export-buttons">
                            <button class="btn-export btn-export-pdf" onclick="event.stopPropagation(); exportReport('expiring-dynamic', 'pdf')" title="Export as PDF">üìÑ PDF</button>
                            <button class="btn-export btn-export-excel" onclick="event.stopPropagation(); exportReport('expiring-dynamic', 'excel')" title="Export as Excel">üìä Excel</button>
                        </div>
                    </div>
                </div>

                <!-- Report Stats Grid -->
                <div class="report-stats-grid">
                    <div class="report-card clickable-report" onclick="showReportAccountsList('all-accounts')" title="Click to view all accounts">
                        <div class="report-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <span>üìä</span>
                        </div>
                        <div class="report-details">
                            <h3>Total Accounts</h3>
                            <div class="report-value" id="report-total-accounts">0</div>
                            <small>All registered accounts</small>
                        </div>
                        <div class="report-export-buttons">
                            <button class="btn-export btn-export-pdf" onclick="event.stopPropagation(); exportReport('all-accounts', 'pdf')" title="Export as PDF">üìÑ PDF</button>
                            <button class="btn-export btn-export-excel" onclick="event.stopPropagation(); exportReport('all-accounts', 'excel')" title="Export as Excel">üìä Excel</button>
                        </div>
                    </div>

                    <div class="report-card clickable-report" onclick="showReportAccountsList('active-accounts')" title="Click to view all active accounts">
                        <div class="report-icon" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                            <span>‚úÖ</span>
                        </div>
                        <div class="report-details">
                            <h3>Active Accounts</h3>
                            <div class="report-value" id="report-active-accounts">0</div>
                            <small>Currently active subscriptions</small>
                        </div>
                        <div class="report-export-buttons">
                            <button class="btn-export btn-export-pdf" onclick="event.stopPropagation(); exportReport('active-accounts', 'pdf')" title="Export as PDF">üìÑ PDF</button>
                            <button class="btn-export btn-export-excel" onclick="event.stopPropagation(); exportReport('active-accounts', 'excel')" title="Export as Excel">üìä Excel</button>
                        </div>
                    </div>

                    <div class="report-card clickable-report" onclick="showReportAccountsList('expired-all')" title="Click to view all expired accounts">
                        <div class="report-icon" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                            <span>‚ùå</span>
                        </div>
                        <div class="report-details">
                            <h3>Expired Accounts</h3>
                            <div class="report-value" id="report-expired-accounts">0</div>
                            <small>Subscriptions that have expired</small>
                        </div>
                        <div class="report-export-buttons">
                            <button class="btn-export btn-export-pdf" onclick="event.stopPropagation(); exportReport('expired-all', 'pdf')" title="Export as PDF">üìÑ PDF</button>
                            <button class="btn-export btn-export-excel" onclick="event.stopPropagation(); exportReport('expired-all', 'excel')" title="Export as Excel">üìä Excel</button>
                        </div>
                    </div>

                    <div class="report-card clickable-report" onclick="showReportAccountsList('expiring-soon')" title="Click to view accounts expiring in next 2 weeks">
                        <div class="report-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                            <span>‚ö†Ô∏è</span>
                        </div>
                        <div class="report-details">
                            <h3>Expiring Soon</h3>
                            <div class="report-value" id="report-expiring-soon">0</div>
                            <small>Expiring in next 2 weeks</small>
                        </div>
                        <div class="report-export-buttons">
                            <button class="btn-export btn-export-pdf" onclick="event.stopPropagation(); exportReport('expiring-soon', 'pdf')" title="Export as PDF">üìÑ PDF</button>
                            <button class="btn-export btn-export-excel" onclick="event.stopPropagation(); exportReport('expiring-soon', 'excel')" title="Export as Excel">üìä Excel</button>
                        </div>
                    </div>

                    <div class="report-card clickable-report" onclick="showReportAccountsList('unlimited-plans')" title="Click to view accounts with unlimited plans">
                        <div class="report-icon" style="background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);">
                            <span>‚ôæÔ∏è</span>
                        </div>
                        <div class="report-details">
                            <h3>Unlimited Plans</h3>
                            <div class="report-value" id="report-unlimited-accounts">0</div>
                            <small>No expiration date</small>
                        </div>
                        <div class="report-export-buttons">
                            <button class="btn-export btn-export-pdf" onclick="event.stopPropagation(); exportReport('unlimited-plans', 'pdf')" title="Export as PDF">üìÑ PDF</button>
                            <button class="btn-export btn-export-excel" onclick="event.stopPropagation(); exportReport('unlimited-plans', 'excel')" title="Export as Excel">üìä Excel</button>
                        </div>
                    </div>

                    <div class="report-card clickable-report" onclick="showReportAccountsList('expired-last-month-static')" title="Click to view accounts expired in last 30 days">
                        <div class="report-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);">
                            <span>üìÖ</span>
                        </div>
                        <div class="report-details">
                            <h3>Expired Last Month</h3>
                            <div class="report-value" id="report-expired-last-month">0</div>
                            <small>Not renewed in 30 days</small>
                        </div>
                        <div class="report-export-buttons">
                            <button class="btn-export btn-export-pdf" onclick="event.stopPropagation(); exportReport('expired-last-month-static', 'pdf')" title="Export as PDF">üìÑ PDF</button>
                            <button class="btn-export btn-export-excel" onclick="event.stopPropagation(); exportReport('expired-last-month-static', 'excel')" title="Export as Excel">üìä Excel</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-content">
                <div class="section-header">
                    <h2>Settings</h2>
                </div>

                <!-- Change Password Section -->
                <div class="settings-item">
                    <div class="settings-item-content">
                        <h3>Change Password</h3>
                        <p>Update your account password</p>
                    </div>
                    <button class="btn-primary" onclick="openModal('changePasswordModal')">Change Password</button>
                </div>

                <!-- Sync Accounts Section (Admin Only) -->
                <div id="sync-section" class="sync-section" style="display:none;">
                    <h3>Sync Accounts</h3>
                    <p>Sync all accounts from Stalker Portal. This will delete all existing accounts and fetch fresh data from the server.</p>
                    <button class="btn-sync" onclick="syncAccounts()">
                        <span id="sync-icon">‚ü≥</span> Sync from Server
                    </button>
                </div>
                <div id="sync-status" class="sync-status" style="display:none;"></div>
            </div>
        </div>
    </div>

    <!-- Add Account Modal -->
    <div id="addAccountModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Account</h3>
                <button class="close-btn" onclick="closeModal('addAccountModal')">&times;</button>
            </div>
            <form onsubmit="addAccount(event)" id="addAccountForm">
                <div class="form-group">
                    <label>Username *</label>
                    <input type="text" name="username" id="account-username" required>
                </div>
                <div class="form-group">
                    <label>Password *</label>
                    <input type="text" name="password" id="account-password" required>
                </div>
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" name="name">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" name="email">
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="text" name="phone_number">
                </div>
                <div class="form-group">
                    <label>MAC Address *</label>
                    <input type="text" name="mac" required placeholder="00:1A:79:xx:xx:xx">
                </div>
                <div class="form-group">
                    <label>Plan</label>
                    <select name="plan" id="plan-select">
                        <option value="0">No Plan</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select name="status">
                        <option value="1">Active</option>
                        <option value="0">Inactive</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Expiry Date (leave empty for auto)</label>
                    <input type="text" name="expire_billing_date" placeholder="YYYY/MM/DD">
                </div>
                <div class="form-group">
                    <label>Comment</label>
                    <textarea name="comment" rows="3"></textarea>
                </div>
                <button type="submit" class="btn-primary">Create Account</button>
            </form>
        </div>
    </div>

    <!-- Add Reseller Modal -->
    <div id="addResellerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Reseller</h3>
                <button class="close-btn" onclick="closeModal('addResellerModal')">&times;</button>
            </div>
            <form onsubmit="addReseller(event)">
                <div class="form-group">
                    <label>Username *</label>
                    <input type="text" name="username" required>
                </div>
                <div class="form-group">
                    <label>Password *</label>
                    <input type="password" name="password" required>
                </div>
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" name="name" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" name="email">
                </div>
                <div class="form-group">
                    <label>Max Users (0 = unlimited)</label>
                    <input type="number" name="max_users" value="0">
                </div>
                <div class="form-group">
                    <label>Currency</label>
                    <select name="currency">
                        <option value="GBP">GBP</option>
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>
                        <option value="IRR">IRR</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Initial Balance</label>
                    <input type="number" step="0.01" name="balance" value="0">
                </div>
                <div class="form-group">
                    <label>Assigned Plans</label>
                    <select name="plans" id="reseller-plans-select" multiple size="8" style="width:100%">
                        <!-- Plans will be loaded dynamically -->
                    </select>
                    <small>Hold Ctrl/Cmd to select multiple plans</small>
                </div>
                <div class="form-group">
                    <label>User Theme</label>
                    <select name="theme" id="add-reseller-theme">
                        <!-- Themes will be loaded dynamically -->
                    </select>
                    <small>Portal theme that will be applied to all subscribers under this reseller</small>
                </div>

                <!-- Permissions Section -->
                <div class="form-group">
                    <label style="font-weight: 600; color: var(--text-primary); margin-bottom: 12px; display: block;">User Type & Permissions</label>
                    <div class="permissions-container">
                        <div class="permission-item permission-observer">
                            <label class="checkbox-label">
                                <input type="checkbox" name="is_observer" value="1">
                                <span>Observer (Read-Only Access)</span>
                            </label>
                            <small style="margin-left: 24px; color: var(--text-tertiary);">Can view everything but cannot make any changes</small>
                        </div>
                        <div class="permission-item permission-admin">
                            <label class="checkbox-label">
                                <input type="checkbox" name="is_admin" value="1">
                                <span>Grant Admin Permissions</span>
                            </label>
                            <small style="margin-left: 24px; color: var(--text-tertiary);">Give full admin access to this reseller</small>
                        </div>
                        <div class="permission-item permission-edit">
                            <label class="checkbox-label">
                                <input type="checkbox" name="can_edit_accounts" value="1">
                                <span>Can Edit Accounts</span>
                            </label>
                            <small style="margin-left: 24px; color: var(--text-tertiary);">Allow reseller to edit existing accounts</small>
                        </div>
                        <div class="permission-item permission-add">
                            <label class="checkbox-label">
                                <input type="checkbox" name="can_add_accounts" value="1">
                                <span>Can Add New Accounts</span>
                            </label>
                            <small style="margin-left: 24px; color: var(--text-tertiary);">Allow reseller to create new accounts</small>
                        </div>
                        <div class="permission-item permission-delete">
                            <label class="checkbox-label">
                                <input type="checkbox" name="can_delete_accounts" value="1">
                                <span>Can Delete Accounts</span>
                            </label>
                            <small style="margin-left: 24px; color: var(--text-tertiary);">Allow reseller to delete accounts</small>
                        </div>
                        <div class="permission-item permission-stb">
                            <label class="checkbox-label">
                                <input type="checkbox" name="can_control_stb" value="1">
                                <span>Can Send STB Events & Messages</span>
                            </label>
                            <small style="margin-left: 24px; color: var(--text-tertiary);">Allow reseller to send events and messages to their customers' devices</small>
                        </div>
                        <div class="permission-item permission-status">
                            <label class="checkbox-label">
                                <input type="checkbox" name="can_toggle_status" value="1">
                                <span>Can Toggle Account Status</span>
                            </label>
                            <small style="margin-left: 24px; color: var(--text-tertiary);">Allow reseller to enable or disable their customers' accounts</small>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn-primary">Create Reseller</button>
            </form>
        </div>
    </div>

    <!-- Edit Reseller Modal -->
    <div id="editResellerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Reseller</h3>
                <button class="close-btn" onclick="closeModal('editResellerModal')">&times;</button>
            </div>
            <form onsubmit="updateReseller(event)">
                <input type="hidden" id="edit-reseller-id" name="id">
                <div class="form-group">
                    <label>Username *</label>
                    <input type="text" id="edit-reseller-username" name="username" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="edit-reseller-password" name="password" placeholder="Leave blank to keep current password">
                    <small>Only enter a password if you want to change it</small>
                </div>
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" id="edit-reseller-name" name="name" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="edit-reseller-email" name="email">
                </div>
                <div class="form-group">
                    <label>Max Users (0 = unlimited)</label>
                    <input type="number" id="edit-reseller-max-users" name="max_users" value="0">
                </div>
                <div class="form-group">
                    <label>Currency</label>
                    <select id="edit-reseller-currency" name="currency">
                        <option value="GBP">GBP</option>
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>
                        <option value="IRR">IRR</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>User Theme</label>
                    <select name="theme" id="edit-reseller-theme">
                        <!-- Themes will be loaded dynamically -->
                    </select>
                    <small class="text-warning"><strong>‚ö†Ô∏è Warning:</strong> Changing the theme will update the Stalker Portal theme for ALL existing accounts under this reseller. This change will take effect immediately.</small>
                </div>

                <!-- Permissions Section -->
                <div class="form-group">
                    <label style="font-weight: 600; color: var(--text-primary); margin-bottom: 12px; display: block;">User Type & Permissions</label>
                    <div class="permissions-container">
                        <div class="permission-item permission-observer">
                            <label class="checkbox-label">
                                <input type="checkbox" id="edit-is-observer" name="is_observer" value="1">
                                <span>Observer (Read-Only Access)</span>
                            </label>
                            <small style="margin-left: 24px; color: var(--text-tertiary);">Can view everything but cannot make any changes</small>
                        </div>
                        <div class="permission-item permission-admin">
                            <label class="checkbox-label">
                                <input type="checkbox" id="edit-is-admin" name="is_admin" value="1">
                                <span>Grant Admin Permissions</span>
                            </label>
                            <small style="margin-left: 24px; color: var(--text-tertiary);">Give full admin access to this reseller</small>
                        </div>
                        <div class="permission-item permission-edit">
                            <label class="checkbox-label">
                                <input type="checkbox" id="edit-can-edit-accounts" name="can_edit_accounts" value="1">
                                <span>Can Edit Accounts</span>
                            </label>
                            <small style="margin-left: 24px; color: var(--text-tertiary);">Allow reseller to edit existing accounts</small>
                        </div>
                        <div class="permission-item permission-add">
                            <label class="checkbox-label">
                                <input type="checkbox" id="edit-can-add-accounts" name="can_add_accounts" value="1">
                                <span>Can Add New Accounts</span>
                            </label>
                            <small style="margin-left: 24px; color: var(--text-tertiary);">Allow reseller to create new accounts</small>
                        </div>
                        <div class="permission-item permission-delete">
                            <label class="checkbox-label">
                                <input type="checkbox" id="edit-can-delete-accounts" name="can_delete_accounts" value="1">
                                <span>Can Delete Accounts</span>
                            </label>
                            <small style="margin-left: 24px; color: var(--text-tertiary);">Allow reseller to delete accounts</small>
                        </div>
                        <div class="permission-item permission-stb">
                            <label class="checkbox-label">
                                <input type="checkbox" id="edit-can-control-stb" name="can_control_stb" value="1">
                                <span>Can Send STB Events & Messages</span>
                            </label>
                            <small style="margin-left: 24px; color: var(--text-tertiary);">Allow reseller to send events and messages to their customers' devices</small>
                        </div>
                        <div class="permission-item permission-status">
                            <label class="checkbox-label">
                                <input type="checkbox" id="edit-can-toggle-status" name="can_toggle_status" value="1">
                                <span>Can Toggle Account Status</span>
                            </label>
                            <small style="margin-left: 24px; color: var(--text-tertiary);">Allow reseller to enable or disable their customers' accounts</small>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn-primary">Update Reseller</button>
            </form>
        </div>
    </div>

    <!-- Add Plan Modal -->
    <div id="addPlanModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Plan</h3>
                <button class="close-btn" onclick="closeModal('addPlanModal')">&times;</button>
            </div>
            <form onsubmit="addPlan(event)">
                <div class="form-group">
                    <label>Select Tariff Plan *</label>
                    <select name="tariff_id" id="tariff-select" required onchange="updatePlanDetails(this)">
                        <option value="">-- Select a tariff --</option>
                    </select>
                    <small>Choose a tariff plan from your Stalker Portal server</small>
                </div>
                <div class="form-group">
                    <label>Plan Name *</label>
                    <input type="text" name="name" id="plan-name-input" required>
                    <small>Auto-filled from tariff, but you can edit it</small>
                </div>
                <div class="form-group">
                    <label>Currency *</label>
                    <select name="currency" required>
                        <option value="GBP">GBP (¬£)</option>
                        <option value="USD">USD ($)</option>
                        <option value="EUR">EUR (‚Ç¨)</option>
                        <option value="IRR">IRR</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Price *</label>
                    <input type="number" step="0.01" name="price" required>
                    <small>Set the price for this plan in selected currency</small>
                </div>
                <div class="form-group">
                    <label>Duration (Days) *</label>
                    <input type="number" name="days" id="plan-days-input" required readonly>
                    <small>Automatically filled from selected tariff</small>
                </div>
                <button type="submit" class="btn-primary">Create Plan</button>
            </form>
        </div>
    </div>

    <!-- Adjust Credit Modal -->
    <div id="adjustCreditModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Adjust Credit</h3>
                <button class="close-btn" onclick="closeModal('adjustCreditModal')">&times;</button>
            </div>
            <form onsubmit="submitCreditAdjustment(event)">
                <input type="hidden" id="adjust-reseller-id" name="reseller_id">
                <div class="form-group">
                    <label>Reseller</label>
                    <input type="text" id="adjust-reseller-name" readonly>
                </div>
                <div class="form-group">
                    <label>Current Balance</label>
                    <input type="text" id="adjust-current-balance" readonly>
                </div>
                <div class="form-group">
                    <label>Action</label>
                    <select name="action" id="adjust-action">
                        <option value="add">Add Credit</option>
                        <option value="deduct">Deduct Credit</option>
                        <option value="set">Set Balance</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Amount *</label>
                    <input type="number" step="0.01" name="amount" id="adjust-amount" required>
                </div>
                <button type="submit" class="btn-primary">Update Credit</button>
            </form>
        </div>
    </div>

    <!-- Assign Plans Modal -->
    <div id="assignPlansModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Assign Plans to Reseller</h3>
                <button class="close-btn" onclick="closeModal('assignPlansModal')">&times;</button>
            </div>
            <form onsubmit="submitPlanAssignment(event)">
                <input type="hidden" id="assign-reseller-id" name="reseller_id">
                <div class="form-group">
                    <label>Reseller</label>
                    <input type="text" id="assign-reseller-name" readonly>
                </div>
                <div class="form-group">
                    <label>Available Plans</label>
                    <div id="assign-plans-checkboxes" class="plans-checkbox-container">
                        <!-- Checkboxes will be loaded dynamically -->
                    </div>
                    <small>Check the plans you want to assign to this reseller. Uncheck to remove access.</small>
                </div>
                <button type="submit" class="btn-primary">Update Plans</button>
            </form>
        </div>
    </div>

    <!-- Edit Account Modal -->
    <div id="editAccountModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Account</h3>
                <button class="close-btn" onclick="closeModal('editAccountModal')">&times;</button>
            </div>
            <form onsubmit="return submitEditAccount(event)" id="editAccountForm">
                <input type="hidden" id="edit-original-username" name="original_username">

                <div class="form-group">
                    <label>Username*</label>
                    <input type="text" id="edit-username" name="username" required>
                    <small>Must be unique.</small>
                </div>

                <div class="form-group">
                    <label>Password</label>
                    <input type="text" id="edit-password" name="password" placeholder="">
                    <small>Leave blank for making no change.</small>
                </div>

                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="edit-name" name="name">
                </div>

                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="edit-email" name="email">
                </div>

                <div class="form-group">
                    <label>Phone number</label>
                    <input type="text" id="edit-phone" name="phone">
                </div>

                <div class="form-group">
                    <label>Plan</label>
                    <select id="edit-plan" name="plan">
                        <option value="0">SELECT ONE TO UPDATE</option>
                        <!-- Plans will be loaded dynamically -->
                    </select>
                </div>

                <div class="form-group">
                    <label>Status</label>
                    <select id="edit-status" name="status">
                        <option value="1">On</option>
                        <option value="0">Off</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Comment</label>
                    <textarea id="edit-comment" name="comment" rows="3"></textarea>
                </div>

                <button type="submit" class="btn-primary">Save</button>
            </form>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Change Password</h3>
                <button class="close-btn" onclick="closeModal('changePasswordModal')">&times;</button>
            </div>
            <form onsubmit="changePassword(event)" id="changePasswordForm">
                <div class="form-group">
                    <label>Old Password *</label>
                    <input type="password" id="old-password" required>
                </div>
                <div class="form-group">
                    <label>New Password *</label>
                    <input type="password" id="new-password" required>
                </div>
                <div class="form-group">
                    <label>Confirm New Password *</label>
                    <input type="password" id="confirm-password" required>
                </div>
                <button type="submit" class="btn-primary">Update Password</button>
            </form>
        </div>
    </div>

    <!-- Assign Reseller Modal -->
    <div id="assignResellerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Assign Account to Reseller</h3>
                <button class="close-btn" onclick="closeModal('assignResellerModal')">&times;</button>
            </div>
            <form id="assignResellerForm" onsubmit="submitAssignReseller(event)">
                <input type="hidden" id="assign-account-username" name="username">

                <div class="form-group">
                    <label>Account Username</label>
                    <input type="text" id="assign-account-display" disabled>
                </div>

                <div class="form-group">
                    <label>Assign to Reseller *</label>
                    <select id="assign-reseller-select" name="reseller_id" required>
                        <option value="">-- Not Assigned --</option>
                    </select>
                    <small>Select a reseller to assign this account, or leave as "Not Assigned"</small>
                </div>

                <button type="submit" class="btn-primary">Assign Reseller</button>
            </form>
        </div>
    </div>

    <script src="dashboard.js"></script>
</body>
</html>
